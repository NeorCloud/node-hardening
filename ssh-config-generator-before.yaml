---
- name: Create .ssh/config file from YAML inventory
  hosts: all
  vars:
    inventory_file_path: /root/bama-dcd-stage/inventory/hosts.yaml
    ssh_config_dir: /root/.ssh
    ssh_config_path: "{{ ssh_config_dir }}/config"
    ssh_user: ansible
    ssh_port: 23389
    ssh_identity_file: /root/.ansible/.ssh/id_ed25519

  tasks:
    - name: Read inventory file
      slurp:
        src: "{{ inventory_file_path }}"
      register: inventory_content

    - name: Parse YAML inventory
      set_fact:
        inventory_data: "{{ inventory_content.content | b64decode | from_yaml }}"

    - name: Create .ssh directory if it doesn't exist
      file:
        path: "{{ ssh_config_dir }}"
        state: directory
        mode: '0700'

    - name: Create .ssh/config file
      copy:
        content: |
          {% for host, hostvars in inventory_data.all.hosts.items() %}
          {% if 'ip' in hostvars %}
          Host {{ host }}
            HostName {{ hostvars.ip }}
            User {{ ssh_user }}
            Port {{ ssh_port }}
            IdentityFile {{ ssh_identity_file }}
          {% endif %}
          {% endfor %}
        dest: "{{ ssh_config_path }}"
        mode: '0644'
